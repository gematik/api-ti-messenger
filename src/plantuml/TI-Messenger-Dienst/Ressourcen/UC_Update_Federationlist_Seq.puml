/' 
# TI-Messenger 1.1.1
# TI-Messenger-Dienst
# UC - 
# Sequence Diagram
# Name: Föderationsliste aktualisieren
'/

@startuml
skinparam sequenceMessageAlign direction
skinparam minClassWidth 200
skinparam BoxPadding 1
skinparam sequenceReferenceHeaderBackgroundColor palegreen
scale max 2048 width

skinparam sequence {
ArrowColor black
ArrowFontSize 17
ActorBorderColor black
LifeLineBorderColor black
LifeLineBackgroundColor Gainsboro

ParticipantBorderColor Motivation
ParticipantBackgroundColor Motivation
ParticipantFontName Impact
ParticipantFontSize 20
ParticipantFontColor black
ParticipantBorderColor Black
ParticipantBackgroundColor MOTIVATION

ActorBackgroundColor Gainsboro
ActorFontColor black
ActorFontSize 20
ActorFontName Aapex
}

box <size:18>Messenger-Service\n #WhiteSmoke
participant MP as "Messenger-Proxy"
participant MH as "Matrix-Homeserver"
end box
participant RD as "Registrierungs-Dienst"
box <size:18>VZD-FHIR-Directory</size> #WhiteSmoke
  participant FP as "FHIR-Proxy"
  participant AS as "OAuth-Service"
end box

legend bottom right
    <size:16>__Legende__</size>
    <size:16><font color=blue>noch optionaler Bestandteil in dieser Spezifikationsversion</font></size>
endlegend

== <size:16>scheduled</size> ==

loop#LightGrey <size:16>alle 1h</size>
  alt#LightGrey <size:16>HealthState_VZD=gesund ODER Alter_Föderationsliste>=1h</size>
  activate RD
  |||
  ref over AS, FP, RD
    <size:16>Provider authentifizieren und Föderationsliste abrufen</size>
  end ref
  |||

  else <size:16>HealthState_VZD!=gesund</size>
    RD ->?: Incident-Event erzeugen()
    RD->RD++: letzte vorhandene Föderationsliste puffern() \n{TTL_Föderationsliste=24h}
    return Föderationsliste
    RD-[hidden]> RD
    deactivate RD
  end
end

== <size:16>on request</size> ==

MP <-?: Föderationsliste \naktualisieren()
activate MP
MP->RD: GET /I_internVerification(FLVersion_MP) 
note right: <size:16>Schnittstelle wird nicht \n<size:16>durch die gematik spezifiziert</size>
|||
  Activate RD

alt#LightGrey <size:16>HealthState_VZD=gesund UND Alter_Föderationsliste>=1h </size>

  |||
  ref over AS, FP, RD
    <size:16>Provider authentifizieren und Föderationsliste abrufen</size>
  end ref
  |||
  
'else <size:16>HealthState_VZD!=gesund ODER Alter_Föderationsliste<1h</size>
else <size:16>HealthState_VZD!=gesund ODER Alter_Föderationsliste<1h</size>

  RD->RD: FLStatus_RD=aktuell

end

break#LightGrey #LightPink <size:16>Alter_Föderationsliste>TTL_Föderationsliste</size>
  RD-->MP: FLStatus_RD=veraltet
  MP->MP: unterbinde Registrierungsdienst-Requests(Dauer=1h)
  |||
end

alt#LightGrey #AliceBlue <size:16>FLStatus_RD=aktuell</size>
    RD->RD++: vergleiche Versionen\n(FLVersion_MP, FLVersion_RD)
    return Vergleichsergebnis_RD
      
      alt#LightGrey #LightBlue <size:16>Vergleichsergebnis_RD=identisch</size>
        ||| 
        RD-->MP: FLStatus_MP=aktuell
        |||
          
      else <size:16>Vergleichsergebnis_RD!=identisch</size>
        RD-->MP: Föderationsliste, x5c-Zertifikatsliste
        MP->MP++: Signatur der Föderationsliste prüfen\n(Föderationsliste, x5c-Zertifikatsliste[1])
        return Signaturprüfergebnis
        |||
        loop#LightGrey #LightSteelBlue <size:16><font color=blue>für jeden Eintrag von x5c-Zertifikatsliste</font></size>
          MP->?: <font color=blue>Public-OCSP-Zertifikatsprüf-Request stellen(x5c-Zertifikat)</font>
          MP <--?: <font color=blue>OCSP-Response</font>
        end
        alt#LightGrey #LightSteelBlue <size:16>Signaturprüfergebnis=gültig <font color=blue>UND jeder OCSP-Response.CertificateStatusValue=good</font></size>
          MP->MP: Föderationsliste aktualisieren(Föderationsliste)
        end
        |||
      end
    |||
    
    else <size:16>FLÄnderungsFlag vorhanden</size>
      RD-->MP: Föderationsliste, x5c-Zertifikatsliste
        Deactivate RD
        MP->MP++: Signatur der Föderationsliste prüfen\n(Föderationsliste, x5c-Zertifikatsliste[1])
        return Signaturprüfergebnis
        |||
        loop#LightGrey #LightSteelBlue <size:16><font color=blue>für jeden Eintrag von x5c-Zertifikatsliste</font></size>
          MP->?: <font color=blue>Public-OCSP-Zertifikatsprüf-Request stellen(x5c-Zertifikat)</font>
          MP <--?: <font color=blue>OCSP-Response</font>
        end
        alt#LightGrey #LightSteelBlue <size:16>Signaturprüfergebnis=gültig <font color=blue>UND jeder OCSP-Response.CertificateStatusValue=good</font></size>
          MP->MP: Föderationsliste aktualisieren(Föderationsliste)
        end
        deactivate MP
        |||
    |||
end
@enduml
