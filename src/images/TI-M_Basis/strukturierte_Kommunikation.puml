@startuml
title FHIR Questionnaire Statusabfrage über Matrix

' Moderneres Design
skinparam Style strictuml
skinparam Shadowing true
skinparam RoundCorner 8
hide footbox
skinparam ArrowColor #3B82F6
skinparam ParticipantBackgroundColor #EAF2FF
skinparam ParticipantBorderColor #3B82F6
skinparam ParticipantFontColor #0F172A
skinparam LifeLineBackgroundColor #F8FAFC
skinparam LifeLineBorderColor #94A3B8
skinparam SequenceMessageAlign center

' Farben für B1/B2
' B1 (grün):  #86EFAC
' B2 (violett): #C4B5FD

autonumber
participant "Dr. Alice (Client A)" as A
participant "Matrix-Raum" as HS
participant "Bob (Client B1)" as B1 #86EFAC
participant "Bob (Client B2)" as B2 #C4B5FD

== Phase 1 – Alice sendet Questionnaire (Event $1) inkl. Status-Anfrage ==
A -> HS : m.room.message ($1)
note over A, HS
{
  "event_id": "$1",
  "type": "m.room.message",
  "sender": "@dr.alice:alice.com",
  "content": {
    // Fragebogen
    "msgtype": "m.file",
    "body": "Bitten füllen sie diesen Fragebogen aus, danke.",
    "filename": "questionnaire.xml",
    "info": {
      "mimetype": "application/fhir+xml",
      ...
    },
    // Anfrage des Verarbeitungsstatus
    "de.gematik.msc4300.request.status": {
      "from_device": "A",
      "lifetime": 600_000, // 10min
    }
    ...
  },
  ...
}
end note

HS -> B1 : Event $1
HS -> B2 : Event $1

' Antwort von B1 farbig (grün)
B1 -[#86EFAC]> HS : de.gematik.msc4300.response.status (ref $1)
note over B1, HS #86EFAC
{
  "type": "de.gematik.msc4300.response.status",
  "sender": "@bob:bob.com",
  "content": {
    "m.response.status": {
      "from_device": "B1",
      "status": "success",
      "messages": [{
        "type": "warning",
        "m.text": [{ "body": "Unbekannte FHIR-Datei wird nur zum Download angeboten" }]
      }]
    },
    "m.relates_to": {
      "event_id": "$1",
      "rel_type": "m.reference",
    },
  }
}
end note
HS -> A : Zustellung Status (B1)

' Antwort von B2 farbig (violett)
B2 -[#C4B5FD]> HS : de.gematik.msc4300.response.status (ref $1)
note over B2, HS #C4B5FD
{
  "type": "de.gematik.msc4300.response.status",
  "sender": "@bob:bob.com",
  "content": {
    "m.response.status": {
      "from_device": "B2",
      "status": "success",
    },
    "m.relates_to": {
      "event_id": "$1",
      "rel_type": "m.reference",
    },
  }
}
end note
HS -> A : Zustellung Status (B2)

== Phase 2 – Bob sendet QuestionnaireResponse (Event $2) inkl. Status-Anfrage ==
' Versand von B2 farbig (violett)
B2 -[#C4B5FD]> HS : m.room.message ($2)
note over B2, HS #C4B5FD
{
  "event_id": "$2",
  "type": "m.room.message",
  "sender": "@bob:bob.com",
  "content": {
    // Ausgefüllter Fragebogen
    "msgtype": "m.file",
    "filename": "questionnaire_response.xml",
    "info": {
      "mimetype": "application/fhir+xml",
      ...
    },
    // Anfrage des Verarbeitungsstatus
    "de.gematik.msc4300.request.status": {
      "from_device": "B2",
      "lifetime": 600_000, // 10min
    }
    ...
  },
  ...
}
end note
HS -> A : Event $2

A -> HS : de.gematik.msc4300.response.status (ref $2)
note over A, HS
{
  "type": "de.gematik.msc4300.response.status",
  "sender": "@dr.alice:alice.com",
  "content": {
    "m.response.status": {
      "from_device": "A",
      "status": "success",
    },
    "m.relates_to": {
      "event_id": "$2",
      "rel_type": "m.reference",
    },
  }
}
end note
HS -> B2 : Zustellung Status (A)
@enduml@startuml
       title FHIR Questionnaire Statusabfrage über Matrix

       ' Moderneres Design
       skinparam Style strictuml
       skinparam Shadowing true
       skinparam RoundCorner 8
       hide footbox
       skinparam ArrowColor #3B82F6
       skinparam ParticipantBackgroundColor #EAF2FF
       skinparam ParticipantBorderColor #3B82F6
       skinparam ParticipantFontColor #0F172A
       skinparam LifeLineBackgroundColor #F8FAFC
       skinparam LifeLineBorderColor #94A3B8
       skinparam SequenceMessageAlign center

       ' Farben für B1/B2
       ' B1 (grün):  #86EFAC
       ' B2 (violett): #C4B5FD

       autonumber
       participant "Dr. Alice (Client A)" as A
       participant "Matrix-Raum" as HS
       participant "Bob (Client B1)" as B1 #86EFAC
       participant "Bob (Client B2)" as B2 #C4B5FD

       == Phase 1 – Alice sendet Questionnaire (Event $1) inkl. Status-Anfrage ==
       A -> HS : m.room.message ($1)
       note over A, HS
       {
         "event_id": "$1",
         "type": "m.room.message",
         "sender": "@dr.alice:alice.com",
         "content": {
           // Fragebogen
           "msgtype": "m.file",
           "body": "Bitten füllen sie diesen Fragebogen aus, danke.",
           "filename": "questionnaire.xml",
           "info": {
             "mimetype": "application/fhir+xml",
             ...
           },
           // Anfrage des Verarbeitungsstatus
           "de.gematik.msc4300.request.status": {
             "from_device": "A",
             "lifetime": 600_000, // 10min
           }
           ...
         },
         ...
       }
       end note

       HS -> B1 : Event $1
       HS -> B2 : Event $1

       ' Antwort von B1 farbig (grün)
       B1 -[#86EFAC]> HS : de.gematik.msc4300.response.status (ref $1)
       note over B1, HS #86EFAC
       {
         "type": "de.gematik.msc4300.response.status",
         "sender": "@bob:bob.com",
         "content": {
           "m.response.status": {
             "from_device": "B1",
             "status": "success",
             "messages": [{
               "type": "warning",
               "m.text": [{ "body": "Unbekannte FHIR-Datei wird nur zum Download angeboten" }]
             }]
           },
           "m.relates_to": {
             "event_id": "$1",
             "rel_type": "m.reference",
           },
         }
       }
       end note
       HS -> A : Zustellung Status (B1)

       ' Antwort von B2 farbig (violett)
       B2 -[#C4B5FD]> HS : de.gematik.msc4300.response.status (ref $1)
       note over B2, HS #C4B5FD
       {
         "type": "de.gematik.msc4300.response.status",
         "sender": "@bob:bob.com",
         "content": {
           "m.response.status": {
             "from_device": "B2",
             "status": "success",
           },
           "m.relates_to": {
             "event_id": "$1",
             "rel_type": "m.reference",
           },
         }
       }
       end note
       HS -> A : Zustellung Status (B2)

       == Phase 2 – Bob sendet QuestionnaireResponse (Event $2) inkl. Status-Anfrage ==
       ' Versand von B2 farbig (violett)
       B2 -[#C4B5FD]> HS : m.room.message ($2)
       note over B2, HS #C4B5FD
       {
         "event_id": "$2",
         "type": "m.room.message",
         "sender": "@bob:bob.com",
         "content": {
           // Ausgefüllter Fragebogen
           "msgtype": "m.file",
           "filename": "questionnaire_response.xml",
           "info": {
             "mimetype": "application/fhir+xml",
             ...
           },
           // Anfrage des Verarbeitungsstatus
           "de.gematik.msc4300.request.status": {
             "from_device": "B2",
             "lifetime": 600_000, // 10min
           }
           ...
         },
         ...
       }
       end note
       HS -> A : Event $2

       A -> HS : de.gematik.msc4300.response.status (ref $2)
       note over A, HS
       {
         "type": "de.gematik.msc4300.response.status",
         "sender": "@dr.alice:alice.com",
         "content": {
           "m.response.status": {
             "from_device": "A",
             "status": "success",
           },
           "m.relates_to": {
             "event_id": "$2",
             "rel_type": "m.reference",
           },
         }
       }
       end note
       HS -> B2 : Zustellung Status (A)
       @enduml